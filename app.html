<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Webdis Chat (Long Polling)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center h-screen">

    <div id="app-container" class="w-full max-w-2xl h-full md:h-[90vh] md:max-h-[700px] bg-white rounded-lg shadow-2xl flex flex-col p-4 md:p-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between pb-4 border-b border-slate-200">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                <h1 class="text-xl font-bold text-slate-800">Live Chat</h1>
            </div>
            <div id="status" class="text-sm text-slate-500 flex items-center">
                <span id="status-indicator" class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-container" class="flex-1 overflow-y-auto my-4 p-4 bg-slate-50 rounded-lg space-y-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Message Input -->
        <div class="mt-auto pt-4 border-t border-slate-200">
            <div class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200" disabled>
                <button id="send-button" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Send
                </button>
            </div>
            <div class="text-xs text-slate-400 mt-2">Your username: <span id="username-display" class="font-medium text-slate-600"></span></div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const WEBDIS_HOST = 'gork';
            const WEBDIS_PORT = 7379;
            // Use a list for pushing and popping messages
            const CHAT_LIST_KEY = 'collaborative_chat_list';
            const WEBDIS_BASE_URL = `http://${WEBDIS_HOST}:${WEBDIS_PORT}`;
            const POLLING_TIMEOUT = 30; // Seconds to wait for a message

            // --- DOM ELEMENTS ---
            const chatContainer = document.getElementById('chat-container');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const usernameDisplay = document.getElementById('username-display');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            // --- STATE ---
            let username = '';

            // --- INITIALIZATION ---
            function init() {
                // Prompt for username
                while (!username || username.trim() === '') {
                    username = prompt("Please enter your username:", `User${Math.floor(Math.random() * 1000)}`);
                }
                usernameDisplay.textContent = username;
                
                // Enable input field
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                // Start listening for messages
                longPoll();

                // Add event listeners
                sendButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                
                addMessage({
                    user: 'System',
                    text: `${username} has joined the chat.`,
                    timestamp: Date.now()
                }, 'system');
            }

            // --- REAL-TIME CONNECTION (LONG POLLING) ---
            async function longPoll() {
                console.log("Waiting for new message...");
                updateStatus('connected', 'Connected');

                try {
                    // BLPOP is a blocking command, perfect for long polling.
                    // It waits for an element to be available on the list.
                    const response = await fetch(`${WEBDIS_BASE_URL}/BLPOP/${CHAT_LIST_KEY}/${POLLING_TIMEOUT}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // BLPOP returns null on timeout, or an array [key, value] on success.
                    if (data && data.BLPOP && data.BLPOP[1]) {
                        const messagePayload = JSON.parse(data.BLPOP[1]);
                        
                        // Don't display our own sent messages twice
                        if (messagePayload.user !== username) {
                           addMessage(messagePayload);
                        }
                    }
                } catch (error) {
                    console.error("Long poll error:", error);
                    updateStatus('error', 'Disconnected. Retrying...');
                    // Wait a moment before retrying on error
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                // Whether we got a message, timed out, or had an error, we start listening again.
                requestAnimationFrame(longPoll);
            }

            // --- SENDING MESSAGES ---
            async function sendMessage() {
                const text = messageInput.value.trim();
                if (text === '') return;

                const messagePayload = {
                    user: username,
                    text: text,
                    timestamp: Date.now()
                };

                // Optimistically add the message to the UI
                addMessage(messagePayload, 'self');
                messageInput.value = '';
                messageInput.focus();

                try {
                    // RPUSH adds the message to the end of the list.
                    const response = await fetch(`${WEBDIS_BASE_URL}/RPUSH/${CHAT_LIST_KEY}`, {
                        method: 'PUT',
                        body: JSON.stringify(messagePayload)
                    });

                    if (!response.ok) {
                        throw new Error(`Webdis RPUSH failed with status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log("Message sent:", result);

                } catch (error) {
                    console.error("Error sending message:", error);
                    const lastMessage = chatContainer.lastElementChild;
                    if(lastMessage) {
                        lastMessage.classList.add('opacity-50');
                        const errorInfo = document.createElement('div');
                        errorInfo.className = 'text-xs text-red-500 text-right mt-1';
                        errorInfo.textContent = 'Failed to send';
                        lastMessage.appendChild(errorInfo);
                    }
                }
            }

            // --- UI UPDATES ---
            function addMessage(msg, type = 'other') {
                const messageWrapper = document.createElement('div');
                const messageBubble = document.createElement('div');
                const authorSpan = document.createElement('div');
                const textSpan = document.createElement('div');
                const timeSpan = document.createElement('div');

                messageWrapper.classList.add('flex', 'flex-col');
                
                messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'break-words');
                authorSpan.classList.add('font-bold', 'text-sm', 'mb-1');
                textSpan.classList.add('text-base');
                timeSpan.classList.add('text-xs', 'mt-1.5', 'opacity-70');

                if (type === 'self') {
                    messageWrapper.classList.add('items-end');
                    messageBubble.classList.add('bg-indigo-600', 'text-white');
                    timeSpan.classList.add('text-indigo-200');
                } else if (type === 'system') {
                    messageWrapper.classList.add('items-center');
                    messageBubble.classList.add('bg-slate-200', 'text-slate-600', 'text-center', 'text-sm', 'py-1', 'px-3');
                } else { // 'other'
                    messageWrapper.classList.add('items-start');
                    messageBubble.classList.add('bg-slate-200', 'text-slate-800');
                    timeSpan.classList.add('text-slate-500');
                }

                authorSpan.textContent = msg.user;
                textSpan.textContent = msg.text;
                timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                if (type !== 'system') {
                    messageBubble.appendChild(authorSpan);
                }
                messageBubble.appendChild(textSpan);
                
                messageWrapper.appendChild(messageBubble);
                if (type !== 'system') {
                    messageWrapper.appendChild(timeSpan);
                }

                chatContainer.appendChild(messageWrapper);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function updateStatus(state, text) {
                statusIndicator.classList.remove('bg-yellow-400', 'bg-green-500', 'bg-red-500');
                switch(state) {
                    case 'connected':
                        statusIndicator.classList.add('bg-green-500');
                        break;
                    case 'error':
                        statusIndicator.classList.add('bg-red-500');
                        break;
                    default:
                        statusIndicator.classList.add('bg-yellow-400');
                }
                statusText.textContent = text;
            }

            // --- START THE APP ---
            init();
        });
    </script>

</body>
</html>
