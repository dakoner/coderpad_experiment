<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Web IDE</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        #main-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        #controls {
            padding: 8px 12px;
            background-color: #252526;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #005a9e;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #file-input {
            display: none;
        }
        #tab-container {
            display: flex;
            background-color: #2d2d2d;
            padding: 0 5px;
            border-bottom: 1px solid #333;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-right: 1px solid #333;
            position: relative;
            background-color: #2d2d2d;
            color: #999;
        }
        .tab.active {
            background-color: #1e1e1e;
            color: #fff;
        }
        .tab-close {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #999;
        }
        .tab-close:hover {
            color: #fff;
        }
        #editor-container {
            flex-grow: 1;
            position: relative;
        }
        #console-container {
            height: 200px;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #333;
        }
        #console-output {
            flex-grow: 1;
            background-color: #1e1e1e;
            padding: 10px;
            overflow-y: auto;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
            color: #ccc;
        }
        .console-error {
            color: #ff6b6b;
        }
        .CodeMirror {
            height: 100%;
            font-size: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
</head>
<body>

    <div id="main-container">
        <div id="controls">
            <button id="run-btn">▶ Run</button>
            <button id="new-btn">New File</button>
            <button id="open-btn">Open File</button>
            <input type="file" id="file-input" accept=".py" multiple>
            <button id="save-btn">Save File</button>
            <span id="loading-status" style="margin-left: auto;">Loading Pyodide...</span>
        </div>

        <div id="tab-container"></div>
        
        <div id="editor-container"></div>

        <div id="console-container">
            <pre id="console-output"></pre>
        </div>
    </div>

    <script>
        const runBtn = document.getElementById('run-btn');
        const newBtn = document.getElementById('new-btn');
        const openBtn = document.getElementById('open-btn');
        const fileInput = document.getElementById('file-input');
        const saveBtn = document.getElementById('save-btn');
        const loadingStatus = document.getElementById('loading-status');
        const tabContainer = document.getElementById('tab-container');
        const editorContainer = document.getElementById('editor-container');
        const consoleOutput = document.getElementById('console-output');

        let pyodide;
        let editors = {}; // Store CodeMirror instances by file ID
        let fileCounter = 0;
        let activeFileId = null;

        // ## Initialization
        async function main() {
            runBtn.disabled = true;
            pyodide = await loadPyodide();
            // Hijack Python's stdout and stderr to display in our console
            pyodide.setStdout({ batched: (msg) => appendToConsole(msg) });
            pyodide.setStderr({ batched: (msg) => appendToConsole(msg, true) });
            loadingStatus.textContent = 'Pyodide Ready!';
            runBtn.disabled = false;
            console.log("Pyodide loaded successfully.");
            createNewFile(); // Start with one empty file
        }

        main();

        // ## Core IDE Functions
        function createNewFile(name = `untitled-${++fileCounter}.py`, content = 'print("Hello, World!")') {
            const fileId = `file-${Date.now()}`;
            
            // Create tab
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.fileId = fileId;
            tab.textContent = name;

            const closeBtn = document.createElement('span');
            closeBtn.className = 'tab-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                closeFile(fileId);
            };
            tab.appendChild(closeBtn);
            tabContainer.appendChild(tab);

            // Create editor instance
            const editorDiv = document.createElement('div');
            editorDiv.style.display = 'none'; // Initially hidden
            editorContainer.appendChild(editorDiv);

            const editor = CodeMirror(editorDiv, {
                value: content,
                mode: 'python',
                theme: 'material-darker',
                lineNumbers: true,
                indentUnit: 4
            });

            editors[fileId] = { editor, name, element: editorDiv, tab };

            tab.onclick = () => switchToFile(fileId);
            switchToFile(fileId);
        }

        function switchToFile(fileId) {
            if (activeFileId) {
                editors[activeFileId].element.style.display = 'none';
                editors[activeFileId].tab.classList.remove('active');
            }

            activeFileId = fileId;
            editors[activeFileId].element.style.display = 'block';
            editors[activeFileId].tab.classList.add('active');
            editors[activeFileId].editor.refresh(); // Important for CodeMirror when shown
            saveBtn.disabled = false;
        }

        function closeFile(fileId) {
            const fileToClose = editors[fileId];
            if (!fileToClose) return;

            // Remove editor and tab elements
            fileToClose.element.remove();
            fileToClose.tab.remove();
            delete editors[fileId];

            if (activeFileId === fileId) {
                const remainingFileIds = Object.keys(editors);
                if (remainingFileIds.length > 0) {
                    switchToFile(remainingFileIds[0]);
                } else {
                    activeFileId = null;
                    saveBtn.disabled = true;
                }
            }
        }

        async function runCode() {
            if (!pyodide || !activeFileId) return;
            
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            consoleOutput.innerHTML = ''; // Clear console on new run
            
            const code = editors[activeFileId].editor.getValue();
            try {
                await pyodide.runPythonAsync(code);
            } catch (err) {
                appendToConsole(err.toString(), true);
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = '▶ Run';
            }
        }

        function appendToConsole(message, isError = false) {
            const line = document.createElement('div');
            line.textContent = message;
            if (isError) {
                line.className = 'console-error';
            }
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // ## File Management
        function openFiles(event) {
            const files = event.target.files;
            if (!files) return;

            for (const file of files) {
                if (file.type && !file.type.startsWith('text/') && !file.name.endsWith('.py')) {
                    appendToConsole(`Cannot open file '${file.name}': Not a text or Python file.`, true);
                    continue;
                }
                const reader = new FileReader();
                reader.onload = (e) => createNewFile(file.name, e.target.result);
                reader.readAsText(file);
            }
            fileInput.value = ''; // Reset for next open
        }

        function saveFile() {
            if (!activeFileId) return;

            const content = editors[activeFileId].editor.getValue();
            const filename = editors[activeFileId].name;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        // ## Event Listeners
        runBtn.addEventListener('click', runCode);
        newBtn.addEventListener('click', () => createNewFile());
        openBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', openFiles);
        saveBtn.addEventListener('click', saveFile);

    </script>
</body>
</html>